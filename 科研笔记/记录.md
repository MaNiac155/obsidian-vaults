
### 最优化控制
研究动机：在约束条件下达到最优的系统表现。
约束：物理条件的限制。
“最优”的判断可以通过数学建模中参数的值来调整。
例如对于下面的图中，小车的最优轨迹可以因为路况不同而有两种情况。
![[Pasted image 20241017211146.png]]
考虑如下图所示的SISO系统，r是给定值/参考值，u是控制器的输出，系统的输入，y是系统的输出。目的是设计一个控制器，调整控制器的输出u，让系统输出$y(t)$尽可能接近参考值$r$.
![[Pasted image 20241017212829.png]]
e是y和r的误差，可以把控制过程看做一个优化问题：
代价函数：
$$
\min J(u)=\int_{0}^{t} qe^2 + ru^2 dt
$$
在存在约束的情况下，求$u$，使得$J(u)$最小。其中，前项$e$是error，越小代表追踪越好。后项$u$是输入，越小代表能耗越小。q和r就是调节参数，用来调整偏重，一般是由工程师来调的。
对于一个多输入多输出的系统，通常用状态空间的数学模型来表示这个系统。所谓状态方程，就是一组用一组一阶微分方程描述系统的状态之间以及输入和状态之间的关系。其中X是系统中的状态变量的向量，U是系统的输入向量，A称为系统矩阵，代表系统内部状态的联系，B称为控制矩阵或输入矩阵，代表输入对状态的作用，C称为输出矩阵。
目标函数用矩阵来表示，实际上是一个二次型，所以是二次优化任务。E是误差，U是输入。和上面的J只有维度的变化。
![[Pasted image 20241017213454.png]]
![[Pasted image 20241017213647.png]]
### MPC模型预测控制 
通过数学模型来预测系统在某一未来时间段内的表现来进行优化控制。多用于数位控制，离散型状态空间表达：
$$
X_{k+1}=AX_{k}+BU_{k}
$$
此为模型。

控制过程可以分为三个步骤：
在第$k$时刻：
1. 估计/测量当前系统状态。
2. 基于$u_k,u_{k+1},...u_{k+n}$ 来进行最优化，
	$$J(u)=\sum _k^{N-1} E_k^TQE_k + U_k^TRU_k + E_N^TFE_N$$
	 $E_k$是当前时刻的误差，$U_k$是当前时刻的输入，$E_N$是最终时刻的误差。
1. 在实施时，并不是把全部的u都实施上去，而是只取$u_k$，然后在k+1时刻重新计算。这个过程叫做滚动优化控制。
![[Pasted image 20241017221651.png]]
#### 在四足机器人的实践中：
MPC用来求解最优的控制量u是机器人的足底反力。
将机器人抽象成一个刚体，这样能够用动力学来建立其数学模型。
![[Pasted image 20241024021440.png]]
由此，可以列出该机器人的受力平衡和力矩平衡两个方程。

经过一长串的计算，最终得到该系统的状态方程可以写成：
![[Pasted image 20241017224151.png]]
x是状态变量，其中的变量依次为位姿（欧拉角）、质心坐标、偏航角速度、质心线速度、重力加速度g（为了形式统一添加上去的）。
u是四条腿的足底反力。

将上式离散化：
![[Pasted image 20241024022744.png]]

预测控制：可以递推地写出来控制周期内每一时刻的状态x和输入u。
![[Pasted image 20241024022917.png]]
可以将上面的式子写成矩阵形式：
$$
X=A_{qp}x(0)+B_{qp}U
$$
其中U是输入变量u组成的向量，其他变量
![[Pasted image 20241024023333.png]]
在上式中，x0是初始时刻的状态，固定值，这样，就把状态X变成了可以只用U表示出来。

接下来可以构造如下优化问题：
![[Pasted image 20241017225033.png]]
其中D是期望轨迹（上一节里面的r），X-D相当于误差，U是待求的控制量 足底反力。**这里求出来的足底反力是为wbc最后的求关节力矩做铺垫。**

在计算过程中，由于只有支撑腿会有足底反力，摆动腿的足底反力肯定是0，所以可以剔除矩阵中的一部分元素方便计算。***另外，mpc的计算频率有一个界限，和步态的周期有个关系。***

求完以后，只采用U中的第一个u(0)，作为该时刻的控制量输入。然后滚动计算。后面足底反力用$^{O}f^{MPC}$来表示。


足底反力约束：需要保证足底与地面不发生相对滑动，足底反力的水平分量不能大于其竖直分量与滑动摩擦系数的乘积，即满足摩擦锥条件。另一方面f也不能太大，需要有个上限。不然撅折了
![[Pasted image 20241024022437.png]]

##### 总结：MPC的作用，是在做什么？
首先在之前有着用户的手柄输入，计算出状态变量X的期望轨迹，也就是要让机器人往什么位置走，包括位姿、线速度、角速度、加速度等的给定值。
通过MPC，计算出足底反力这一控制量，通过力->加速度->速度、位置的正运动学过程，让机器人的上述状态变量和期望轨迹相符。
优点：能够应对复杂度高的问题，基于预测未来，能够更好的适应系统变化。
缺点：计算难度大，需要较高的系统建模能力，实时性较差。在实践中mpc的计算频率也低，算的慢。

## wbc全身控制

为了让机器人能够有优先级地完成多个任务，可以利用机器人冗余的自由度去完成额外的任务，例如机械臂在抓取物体的过程中躲避障碍物。对任务划分优先级，高优先级任务可以直接求解，低优先级任务需要在不干扰高优先级任务的前提下进行。

已知工作空间位置x，求关节空间q，q·，q··
最后得到关节空间广义加速度q·· 广义：有虚拟关节、有角度和长度（P53）
子任务划分，4个任务，依次计算J，？？？
松弛优化，相当于统一两个控制器。
最后用动力学方程计算出关节扭矩。






在MPC中求最优化的过程中，
问题（？
SafeOpt那篇文章调整的是PD控制器的kp和kd，那么在前面的过程中还有许多参数是手动调的，这些参数能不能用类似的优化方法来调呢？例如mpc中做优化任务时的Q和R权重矩阵（yuxianyuanP44）还有wbc里的权重矩阵（P56）