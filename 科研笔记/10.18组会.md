在之前的论文《Tuning Legged Locomotion Controllers via Safe Bayesian Optimization》中，是使用安全贝叶斯对MPC+WBC的控制器进行优化。因此，这段时间学习了一下MPC和WBC的原理。
![[Pasted image 20241017210443.png]]

### 最优化控制
研究动机：在约束条件下达到最优的系统表现。
约束：物理条件的限制。
“最优”的判断可以通过数学建模中参数的值来调整。
例如对于下面的图中，小车的最优轨迹可以因为路况不同而有两种情况。
![[Pasted image 20241017211146.png]]
考虑如下图所示的SISO系统，要让输出$y(t)$尽可能接近参考值$r$.
![[Pasted image 20241017212829.png]]
代价函数：
$$
\min J=\int_{0}^{t} qe^2 + ru^2 dt
$$
在存在约束的情况下，求$u$，使得$J(u)$最小。其中，前项$e$是error，越小代表追踪越好。后项$u$是输入，越小代表能耗越小。q和r就是调节参数，用来调整偏重。
如下图的MIMO系统，目标函数用矩阵来表示，实际上是一个二次型，所以是二次优化任务。
![[Pasted image 20241017213454.png]]
![[Pasted image 20241017213647.png]]

### MPC模型预测控制 
通过数学模型来预测系统在某一未来时间段内的表现来进行优化控制。多用于数位控制，离散型状态空间表达：
$$
X_{k+1}=AX_{k}+BU_{k}
$$
![[Pasted image 20241017221651.png]]
可以分为三个步骤：
在第$k$时刻：
1. 估计/测量当前系统状态。
2. 基于$u_k,u_{k+1},...u_{k+n}$ 来进行最优化，
	$$J=\sum _k^{N-1} E_k^TQE_k + U_k^TRU_k + E_N^TFE_N$$
	 $E_k$是当前时刻的误差，$U_k$是当前时刻的输入，$E_N$是最终时刻的误差。
3. 在实施时，并不是把全部的u都实施上去，而是只取u_k，然后在k+1时刻重新计算。这个过程叫做滚动优化控制。
#### 数学推导
#### 在四足机器人的实践中：
MPC用来求解最优的足底反力。
状态方程可以写成：
![[Pasted image 20241017224151.png]]
x是状态，包括了位姿（欧拉角）、坐标、角速度、线速度等。
u是四条腿的足底反力。
在MPC中求最优化的过程中，可以构造如下优化问题：
![[Pasted image 20241017225033.png]]
解出来的u即为控制量 足底反力。该控制量会作为WBC中的输入。

### 全身控制
wbc算法是一种集成了多种控制策略的算法，旨在同时控制机器人的多个自由度，已实现复杂的运动和任务。在使用WBC算法时需要建立机器人的运动学和动力学模型，并定义机器人需要完成的任务，包括机器人平衡、行走等。可以根据重要程度对任务排序，高优先级任务可以直接求解，低优先级任务需要在不干扰高优先级任务的前提下进行。通常采用零空间投影的办法解决，通过一个统一的优化问题来同时考虑多个任务和约束条件。
![[Pasted image 20241018102719.png]]
对于一个多关节的机器人，称工作空间x为期望机器人运动的轨迹，称关节空间q为机器人上若干关节的参数。则有x=f(q) 是从关节空间到工作空间的映射。对于一个q，必然存在一个x，反之不然。在有些情况下，无法找到满足工作空间x的关节角度q，即机器人再怎么扭动也到达不了期望位置；另一些情况下，到达同一个工作空间x，有多种的q能够满足。称这种为冗余机器人。在尽可能保证工作空间任务x完成的前提下，关节可以按照q的速度任意运动，来实现其他额外任务。这种利用冗余来同时完成多个任务，就是全身控制。

下周的安排：
1.MPC的数学推导基本看懂了，但WBC的推导过程还没看完。所以先把这部分看一下。
2.需要搞明白那篇要复现的论文是怎么把贝叶斯优化和MPC+WBC组装起来的。因为WBC的输出已经是各关节力矩的输出值了，不知道贝叶斯优化是在优化什么位置的参数。需要再读一下那篇论文。
3.研究一下仿真平台。师兄他们在狗上跑起来的dfki的代码附带了一个仿真平台Drake，但又跟网上找到的教程不太一样，可能是自己有所修改。得问一下学长他们该怎么办。如果仿真平台能搭好，就看看代码。




##### 雅各比矩阵
用来联系机械臂的关节空间和操作空间。
对于一个机械臂，其末端执行器的位置和姿态通常是由多个关节角度决定的。假设机械臂有 n 个自由度，其末端执行器在操作空间中的位置和姿态可以表示为一个向量 x，而关节角度可以表示为一个向量 q。雅各比矩阵 J 描述了这两者之间的速率关系：

$\dot{x}=J(q)\dot{q}$

这里， $\dot x$ 是末端执行器的位置和姿态的速度向量， $\dot q$ 是关节角速度的向量。
雅各比矩阵 J 是一个 m×n 的矩阵，其中 m 是末端执行器的位置和姿态的维度， n 是关节的自由度数。其元素可以通过对末端执行器的位置和姿态函数 x=f(q) 关于关节角度 q 进行偏导数来计算，即：
$J_{ij}=\frac {\partial x_i}{\partial q_j}$

##### 零空间投影


伪逆矩阵：AA†A=A
com: center of mass

A和B是啥？？？
A称为系统矩阵，代表系统内部状态的联系，B称为控制矩阵或输入矩阵，代表输入对状态的作用，C称为输出矩阵